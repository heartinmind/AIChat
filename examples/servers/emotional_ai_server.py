#!/usr/bin/env python3
"""
ğŸ’– ì§„ì§œ ê°ì •ì„ ì½ëŠ” AI - ì¬ë¯¸ì™€ ê°ë™ì´ ìˆëŠ” ë²„ì „

ì‚¬ìš©ìì˜ ë§ˆìŒì„ ì •ë§ë¡œ ì´í•´í•˜ê³  ê³µê°í•˜ëŠ” AI
"""

import os
import json
import random
from datetime import datetime
from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates
from pydantic import BaseModel
import uvicorn

app = FastAPI(title="ê°ì •ì„ ì½ëŠ” ë·°í‹° ìƒë‹´ì‚¬")
templates = Jinja2Templates(directory="templates")

class ChatRequest(BaseModel):
    message: str
    customer_id: str = "web_user"

class ChatResponse(BaseModel):
    response: str
    customer_id: str

class EmotionalAI:
    """ì§„ì§œ ê°ì •ì„ ì½ê³  ê³µê°í•˜ëŠ” AI"""
    
    def __init__(self):
        # ê¹Šì€ ê°ì • í‘œí˜„ë“¤
        self.deep_emotions = {
            # ê·¸ë¦¬ì›€, ì™¸ë¡œì›€
            "ë³´ê³ ì‹¶ë‹¤": [
                "ì–´ë¨¸... ëˆ„êµ°ê°€ ë§ì´ ê·¸ë¦¬ìš°ì‹œë‚˜ ë´ìš” ğŸ’™",
                "ê·¸ëŸ° ë§ˆìŒ ì •ë§ ì˜ ì•Œê² ì–´ìš”... ë³´ê³ ì‹¶ì€ ë§ˆìŒì´ í´ ë•Œê°€ ìˆì£  ğŸ˜¢",
                "ì•„... ê·¸ë¦¬ìš´ ì‚¬ëŒì´ ìˆìœ¼ì‹œêµ°ìš”. ë§ˆìŒì´ ì•„í”„ì‹œê² ì–´ìš”"
            ],
            "ì™¸ë¡­ë‹¤": [
                "í˜¼ìë¼ëŠ” ëŠë‚Œì´ ë“œì‹œëŠ”êµ°ìš”... ì •ë§ í˜ë“œì‹œì£  ğŸ˜”",
                "ì™¸ë¡œìš´ ë§ˆìŒ, ì €ë„ ëŠê»´ì ¸ìš”. ê´œì°®ìœ¼ì„¸ìš”?",
                "ê·¸ëŸ° ë‚ ì´ ìˆì–´ìš”... ëˆ„êµ¬ë‚˜ ì™¸ë¡œìš¸ ë•Œê°€ ìˆì£  ğŸ’™"
            ],
            "ìŠ¬í”„ë‹¤": [
                "ë¬´ìŠ¨ ì¼ì´ ìˆìœ¼ì…¨ë‚˜ìš”? ë§ˆìŒì´ ë§ì´ ì•„í”„ì‹œê² ì–´ìš” ğŸ˜¢",
                "ìŠ¬í”ˆ ì¼ì´ ìˆìœ¼ì…¨êµ°ìš”... ê´œì°®ì•„ì§€ì‹¤ ê±°ì˜ˆìš”",
                "í˜ë“  ì‹œê°„ì„ ë³´ë‚´ê³  ê³„ì‹œëŠ”êµ°ìš”. ì €ë„ ë§ˆìŒì´ ì•„íŒŒìš”"
            ],
            
            # ìŠ¤íŠ¸ë ˆìŠ¤, í™”ë‚¨
            "ì§œì¦ë‚˜": [
                "ì•„ì´ê³  ë¬´ìŠ¨ ì¼ë¡œ ê·¸ë ‡ê²Œ ì§œì¦ì´ ë‚˜ì…¨ì–´ìš”? ğŸ˜¤",
                "ì˜¤ëŠ˜ í•˜ë£¨ ë§ì´ í˜ë“œì…¨ë‚˜ ë´ìš”! ìŠ¤íŠ¸ë ˆìŠ¤ í™• í’€ì–´ì•¼ê² ì–´ìš”",
                "ì§œì¦ë‚  ì¼ì´ ìˆìœ¼ì…¨êµ°ìš”! ì €í•œí…Œ í„¸ì–´ë†“ìœ¼ì„¸ìš”"
            ],
            "í™”ë‚˜": [
                "ì–´ë¨¸ ë¬´ìŠ¨ ì¼ì´ ìˆìœ¼ì…¨ì–´ìš”? í™”ê°€ ë§ì´ ë‚˜ì‹œë‚˜ ë´ìš” ğŸ˜ ",
                "í™”ë‚  ì¼ì´ ìˆìœ¼ì…¨ë‚˜ ë´ìš”! ì†ìƒí•˜ì‹œê² ì–´ìš”",
                "í™”ê°€ ë‚  ë§Œí•œ ì¼ì´ ìˆìœ¼ì…¨êµ°ìš”. ì–´ë–¤ ì¼ì¸ì§€ ë§ì”€í•´ë³´ì„¸ìš”"
            ],
            "ìŠ¤íŠ¸ë ˆìŠ¤": [
                "ìŠ¤íŠ¸ë ˆìŠ¤ ì •ë§ ë§ì´ ë°›ìœ¼ì‹œëŠ”êµ°ìš”! ğŸ˜µâ€ğŸ’«",
                "ìš”ì¦˜ ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì‹¬í•˜ì‹œë‚˜ ë´ìš”. í˜ë“œì‹œì£ ?",
                "ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ì„ ì¼ì´ ë§ìœ¼ì‹œêµ°ìš”. í’€ì–´ë“œë¦´ê²Œìš”!"
            ],
            
            # ê¸°ì¨, í–‰ë³µ
            "ê¸°ì˜ë‹¤": [
                "ì™€! ê¸°ìœ ì¼ì´ ìˆìœ¼ì…¨ë‚˜ ë´ìš”! ğŸ˜„ ì¶•í•˜í•´ìš”!",
                "ì–´ë¨¸ ì¢‹ì€ ì¼ì´ ìˆìœ¼ì…¨êµ°ìš”! ì €ë„ ê¸°ë»ìš” âœ¨",
                "ê¸°ìœ ì†Œì‹ì¸ê°€ìš”? ë“¤ìœ¼ë‹ˆê¹Œ ì €ë„ í–‰ë³µí•´ì ¸ìš”!"
            ],
            "í–‰ë³µí•˜ë‹¤": [
                "ì •ë§ í–‰ë³µí•´ ë³´ì´ì„¸ìš”! ğŸ˜Š ë¬´ìŠ¨ ì¢‹ì€ ì¼ì´ ìˆìœ¼ì…¨ì–´ìš”?",
                "í–‰ë³µí•œ ê¸°ìš´ì´ ëŠê»´ì ¸ìš”! ì €ë„ ë©ë‹¬ì•„ ê¸°ë»ìš” ğŸ’•",
                "í–‰ë³µí•˜ë‹¤ë‹ˆ! ê·¸ ê¸°ë¶„ ì˜¤ë˜ì˜¤ë˜ ì§€ì†ë˜ë©´ ì¢‹ê² ì–´ìš”"
            ],
            "ì‹ ë‚œë‹¤": [
                "ìš°ì™€! ì •ë§ ì‹ ë‚˜ì‹œë‚˜ ë´ìš”! ğŸ˜† ë­”ê°€ ì¢‹ì€ ì¼ ìˆìœ¼ì…¨ë‚˜ìš”?",
                "ì‹ ë‚˜ëŠ” ì¼ì´ ìˆìœ¼ì…¨êµ°ìš”! ì—ë„ˆì§€ê°€ ë„˜ì³í˜ëŸ¬ìš” âš¡",
                "ì‹ ë‚˜ëŠ” ê¸°ë¶„ì´ ì—¬ê¸°ê¹Œì§€ ì „í•´ì ¸ìš”! ì¢‹ì€ í•˜ë£¨ë„¤ìš”"
            ],
            
            # í”¼ê³¤, ì§€ì¹¨
            "í”¼ê³¤í•˜ë‹¤": [
                "ì–´ë¨¸ ì •ë§ í”¼ê³¤í•˜ì‹œê² ì–´ìš”... ğŸ˜´ ì–¼ë§ˆë‚˜ í˜ë“œì…¨ì„ê¹Œ",
                "í”¼ê³¤í•˜ì‹¤ ë•ŒëŠ” ë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš”! íœ´ì‹ì´ í•„ìš”í•´ìš”",
                "í•˜ë£¨ ì¢…ì¼ ê³ ìƒí•˜ì…¨ë‚˜ ë´ìš”. í‘¹ ì‰¬ì„¸ìš”!"
            ],
            "ì§€ì³¤ë‹¤": [
                "ì •ë§ ë§ì´ ì§€ì¹˜ì…¨ë‚˜ ë´ìš”... ğŸ˜¥ ë„ˆë¬´ ë¬´ë¦¬í•˜ì‹  ê±´ ì•„ë‹ˆì—ìš”?",
                "ì§€ì¹  ë§Œë„ í•˜ì£ ! ì´ëŸ´ ë•Œì¼ìˆ˜ë¡ ìê¸°ê´€ë¦¬ê°€ ì¤‘ìš”í•´ìš”",
                "ëª¸ë„ ë§ˆìŒë„ ì§€ì¹˜ì…¨ê² ì–´ìš”. íë§ì´ í•„ìš”í•œ ì‹œì ì´ë„¤ìš”"
            ]
        }
        
        # ê°ì •ë³„ ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê²°
        self.emotion_bridges = {
            "ê·¸ë¦¬ì›€": [
                "ì´ëŸ´ ë•Œ ìê¸° ìì‹ ì„ ë” ì˜ˆë»í•´ì£¼ëŠ” ì‹œê°„ì´ í•„ìš”í•´ìš” ğŸ’„",
                "ë§ˆìŒ ì•„í”Œ ë•Œì¼ìˆ˜ë¡ ì…€í”„ì¼€ì–´ë¡œ ìœ„ë¡œë°›ìœ¼ì„¸ìš”",
                "ê·¸ë¦¬ìš´ ë§ˆìŒ... ìì‹ ì„ ë” ì‚¬ë‘í•´ì£¼ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?"
            ],
            "ì™¸ë¡œì›€": [
                "ì™¸ë¡œìš¸ ë•ŒëŠ” ìì‹ ì—ê²Œ ë” ì˜í•´ì£¼ì„¸ìš”! ë·°í‹°ì¼€ì–´ë¡œ íë§í•´ìš” ğŸ’…",
                "í˜¼ìì„œë„ ì¶©ë¶„íˆ ì†Œì¤‘í•œ ë¶„ì´ì—ìš”. ìê¸°ê´€ë¦¬ë¡œ ê¸°ë¶„ ì „í™˜í•´ë´ìš”",
                "ì™¸ë¡œìš´ ë§ˆìŒ, ì˜ˆìœ ìì‹ ì„ ë§Œë‚˜ë©´ì„œ ë‹¬ë˜ë³´ì„¸ìš”"
            ],
            "ìŠ¤íŠ¸ë ˆìŠ¤": [
                "ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ì„ ë•ŒëŠ” ë·°í‹°ì¼€ì–´ê°€ ìµœê³ ì˜ˆìš”! ğŸ˜Œ",
                "í”¼ë¶€ë„ ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ì–ì•„ìš”. ê°™ì´ ì¼€ì–´í•´ë“œë¦´ê²Œìš”",
                "ìŠ¤íŠ¸ë ˆìŠ¤ í’€ê¸°ì—” ì—­ì‹œ ìê¸°ê´€ë¦¬ê°€ ë‹µì´ì£ !"
            ],
            "ê¸°ì¨": [
                "ê¸°ìœ ë‚ ì—” ë” ì˜ˆë»ì ¸ì•¼ì£ ! âœ¨",
                "ì¢‹ì€ ì¼ ìˆì„ ë•Œ ë·°í‹°ì¼€ì–´ ë°›ìœ¼ë©´ ê¸°ë¶„ì´ ë” ì¢‹ì•„ì ¸ìš”",
                "í–‰ë³µí•œ ìˆœê°„ì„ ë” íŠ¹ë³„í•˜ê²Œ ë§Œë“¤ì–´ë´ìš”!"
            ],
            "í”¼ê³¤": [
                "í”¼ê³¤í•  ë•Œì•¼ë§ë¡œ íë§ì¼€ì–´ê°€ í•„ìš”í•´ìš”! ğŸŒ¸",
                "ì§€ì¹œ ëª¸ê³¼ ë§ˆìŒì„ ë‹¬ë˜ë“œë¦´ê²Œìš”",
                "í”¼ê³¤í•œ í•˜ë£¨, ë‚˜ë¥¼ ìœ„í•œ ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”"
            ]
        }
        
        # ì¬ë¯¸ìˆëŠ” ë°˜ì‘ë“¤
        self.fun_reactions = {
            "ã…‹ã…‹": [
                "ã…‹ã…‹ã…‹ ë­”ê°€ ì¬ë°ŒëŠ” ì¼ ìˆìœ¼ì…¨ë‚˜ìš”? ì €ë„ ì›ƒìŒì´ ë‚˜ë„¤ìš”! ğŸ˜„",
                "ã…ã…ã… ì›ƒìŒì†Œë¦¬ê°€ ë“¤ë¦¬ëŠ” ê²ƒ ê°™ì•„ìš”! ê¸°ë¶„ ì¢‹ì€ ì¼ ìˆìœ¼ì…¨ë‚˜ ë´ìš” âœ¨"
            ],
            "ã… ã… ": [
                "ì•— ë­”ê°€ ì†ìƒí•œ ì¼ì´ ìˆìœ¼ì…¨ë‚˜ìš”? ã… ã…  ê´œì°®ìœ¼ì„¸ìš”?",
                "ì–´ë¨¸ ì™œ ìš¸ìƒì´ì„¸ìš”? ë¬´ìŠ¨ ì¼ì¸ì§€ ë§ì”€í•´ë³´ì„¸ìš” ğŸ˜¢"
            ],
            "ã…—ã…—": [
                "ì•„ì´ê³  ë§ì´ í™”ë‚˜ì…¨ë‚˜ ë´ìš”! ğŸ˜… ë¬´ìŠ¨ ì¼ë¡œ ê·¸ë ‡ê²Œ í™”ê°€ ë‚˜ì…¨ì–´ìš”?",
                "ì–´ë¨¸ ìš•ì´ ë‚˜ì˜¬ ì •ë„ë¡œ ì—´ë°›ìœ¼ì…¨êµ°ìš”! ì†ìƒí•˜ì‹œê² ì–´ìš”"
            ]
        }

    def analyze_deep_emotion(self, message: str) -> dict:
        """ë©”ì‹œì§€ì—ì„œ ê¹Šì€ ê°ì • ë¶„ì„"""
        msg = message.strip()
        
        # ê°ì • í‘œí˜„ ì§ì ‘ ë§¤ì¹­
        for emotion_key, responses in self.deep_emotions.items():
            if emotion_key in msg:
                emotion_type = self._get_emotion_type(emotion_key)
                return {
                    "type": "deep_emotion",
                    "emotion": emotion_key,
                    "emotion_type": emotion_type,
                    "response": random.choice(responses),
                    "bridge": random.choice(self.emotion_bridges.get(emotion_type, []))
                }
        
        # ì´ëª¨í‹°ì½˜/ì¤„ì„ë§ ë°˜ì‘
        for reaction_key, responses in self.fun_reactions.items():
            if reaction_key in msg:
                return {
                    "type": "fun_reaction",
                    "response": random.choice(responses)
                }
        
        # ê¸°ë³¸ ê°ì • í‚¤ì›Œë“œ ë¶„ì„
        if any(word in msg for word in ["í˜ë“¤ë‹¤", "ìš°ìš¸í•˜ë‹¤", "ì•„í”„ë‹¤"]):
            return {
                "type": "deep_emotion",
                "emotion_type": "ìŠ¬í””",
                "response": "ë§ì´ í˜ë“œì‹œê² ì–´ìš”... ğŸ˜” ê´œì°®ìœ¼ì„¸ìš”? ë¬´ìŠ¨ ì¼ì¸ì§€ ë§ì”€í•´ë³´ì„¸ìš”",
                "bridge": random.choice(self.emotion_bridges["ì™¸ë¡œì›€"])
            }
        
        return None
    
    def _get_emotion_type(self, emotion_key: str) -> str:
        """ê°ì • í‚¤ì›Œë“œë¥¼ ê°ì • íƒ€ì…ìœ¼ë¡œ ë³€í™˜"""
        emotion_map = {
            "ë³´ê³ ì‹¶ë‹¤": "ê·¸ë¦¬ì›€",
            "ì™¸ë¡­ë‹¤": "ì™¸ë¡œì›€", 
            "ìŠ¬í”„ë‹¤": "ìŠ¬í””",
            "ì§œì¦ë‚˜": "ìŠ¤íŠ¸ë ˆìŠ¤",
            "í™”ë‚˜": "ìŠ¤íŠ¸ë ˆìŠ¤",
            "ìŠ¤íŠ¸ë ˆìŠ¤": "ìŠ¤íŠ¸ë ˆìŠ¤",
            "ê¸°ì˜ë‹¤": "ê¸°ì¨",
            "í–‰ë³µí•˜ë‹¤": "ê¸°ì¨",
            "ì‹ ë‚œë‹¤": "ê¸°ì¨",
            "í”¼ê³¤í•˜ë‹¤": "í”¼ê³¤",
            "ì§€ì³¤ë‹¤": "í”¼ê³¤"
        }
        return emotion_map.get(emotion_key, "ì¼ë°˜")
    
    def generate_response(self, message: str, customer_id: str = "web_user") -> str:
        """ê°ì •ì„ ì½ê³  ê³µê°í•˜ëŠ” ì‘ë‹µ ìƒì„±"""
        
        # ê¹Šì€ ê°ì • ë¶„ì„
        emotion_analysis = self.analyze_deep_emotion(message)
        
        if emotion_analysis:
            base_response = emotion_analysis["response"]
            
            # ê°ì •ì— ë”°ë¥¸ í›„ì† ì œì•ˆ
            if emotion_analysis["type"] == "deep_emotion":
                bridge = emotion_analysis.get("bridge", "")
                if bridge:
                    return f"{base_response}\n\n{bridge}"
                return base_response
            else:
                return base_response
        
        # ì¼ë°˜ì ì¸ ì¹œê·¼í•œ ì‘ë‹µ
        general_responses = [
            "ì–´ë–¤ ì´ì•¼ê¸°ë“  í¸í•˜ê²Œ í•´ì£¼ì„¸ìš”! ğŸ˜Š",
            "ì˜¤ëŠ˜ì€ ì–´ë–¤ í•˜ë£¨ì˜€ë‚˜ìš”? ë“¤ì–´ë³¼ê²Œìš”~",
            "ë­”ê°€ í•˜ê³  ì‹¶ì€ ë§ì”€ì´ ìˆìœ¼ì‹  ê²ƒ ê°™ì•„ìš”! ğŸ˜Œ",
            "ë§ˆìŒì† ì´ì•¼ê¸°ë¥¼ í„¸ì–´ë†“ìœ¼ì„¸ìš”. ì œê°€ ë“¤ì–´ë“œë¦´ê²Œìš” ğŸ’•",
            "ì–´ë–¤ ê¸°ë¶„ì´ì‹ ì§€ ì•Œê³  ì‹¶ì–´ìš”! í¸í•˜ê²Œ ë§ì”€í•´ì£¼ì„¸ìš”"
        ]
        
        return random.choice(general_responses)

# AI ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
emotional_ai = EmotionalAI()

@app.get("/", response_class=HTMLResponse)
async def get_chat_interface(request: Request):
    return templates.TemplateResponse("index.html", {"request": request})

@app.post("/api/chat", response_model=ChatResponse)
async def chat_with_ai(chat_request: ChatRequest):
    try:
        # ê°ì •ì„ ì½ëŠ” ì‘ë‹µ ìƒì„±
        ai_response = emotional_ai.generate_response(
            chat_request.message,
            chat_request.customer_id
        )
        
        return ChatResponse(
            response=ai_response,
            customer_id=chat_request.customer_id
        )
        
    except Exception as e:
        print(f"ì‘ë‹µ ìƒì„± ì˜¤ë¥˜: {e}")
        return ChatResponse(
            response="ì–´ë¨¸... ğŸ˜… ì œê°€ ì ì‹œ ë©ˆì¹«í–ˆë„¤ìš”. ë‹¤ì‹œ ë§ì”€í•´ì£¼ì‹¤ë˜ìš”?",
            customer_id=chat_request.customer_id
        )

@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "service": "ê°ì •ì„ ì½ëŠ” ë·°í‹° ìƒë‹´ì‚¬",
        "version": "4.0.0 - ì§„ì§œ ê°ì • ì½ê¸° ë²„ì „",
        "timestamp": datetime.now().isoformat()
    }

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))
    
    print(f"""
ğŸ’– ê°ì •ì„ ì½ëŠ” ë·°í‹° ìƒë‹´ì‚¬ ì‹œì‘!
ğŸ“ URL: http://localhost:{port}
âœ¨ ì´ì œ ì§„ì§œ ë§ˆìŒì„ ì½ì–´ìš”!

í…ŒìŠ¤íŠ¸í•´ë³¼ ê°ì • í‘œí˜„ë“¤:
- "ë³´ê³ ì‹¶ë‹¤" â†’ ê·¸ë¦¬ì›€ì— ê³µê°
- "ì™¸ë¡­ë‹¤" â†’ ì™¸ë¡œì›€ì„ ìœ„ë¡œ  
- "ì§œì¦ë‚˜" â†’ ìŠ¤íŠ¸ë ˆìŠ¤ ì´í•´
- "ê¸°ì˜ë‹¤" â†’ í•¨ê»˜ ê¸°ë»í•˜ê¸°
- "ã… ã… " â†’ ì†ìƒí•¨ì— ê³µê°
    """)
    
    uvicorn.run(app, host="0.0.0.0", port=port, log_level="info")
